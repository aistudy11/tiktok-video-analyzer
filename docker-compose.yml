version: '3.8'

services:
  # Redis
  redis:
    image: redis:7-alpine
    hostname: redis
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: always
    networks:
      - app-network

  # FastAPI 后端 (Dokploy 需要服务名为 gateway)
  gateway:
    build:
      context: ./backend
      dockerfile: Dockerfile
    hostname: gateway
    ports:
      - "8000:8000"
    volumes:
      - storage_data:/app/storage
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - FEISHU_APP_ID=${FEISHU_APP_ID}
      - FEISHU_APP_SECRET=${FEISHU_APP_SECRET}
      - FEISHU_BITABLE_APP_TOKEN=${FEISHU_BITABLE_APP_TOKEN}
      - FEISHU_BITABLE_TABLE_ID=${FEISHU_BITABLE_TABLE_ID}
      - STORAGE_PATH=${STORAGE_PATH:-/app/storage}
      - VIDEO_STORAGE_PATH=${VIDEO_STORAGE_PATH:-/app/storage/videos}
      - ANALYSIS_STORAGE_PATH=${ANALYSIS_STORAGE_PATH:-/app/storage/analysis}
      - API_SECRET_KEY=${API_SECRET_KEY:-tiktok-analyzer-secret-key-2024}
      - DEBUG=${DEBUG:-false}
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    restart: always
    networks:
      - app-network

  # Celery Worker
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    hostname: celery_worker
    volumes:
      - storage_data:/app/storage
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - FEISHU_APP_ID=${FEISHU_APP_ID}
      - FEISHU_APP_SECRET=${FEISHU_APP_SECRET}
      - FEISHU_BITABLE_APP_TOKEN=${FEISHU_BITABLE_APP_TOKEN}
      - FEISHU_BITABLE_TABLE_ID=${FEISHU_BITABLE_TABLE_ID}
      - STORAGE_PATH=${STORAGE_PATH:-/app/storage}
      - VIDEO_STORAGE_PATH=${VIDEO_STORAGE_PATH:-/app/storage/videos}
      - ANALYSIS_STORAGE_PATH=${ANALYSIS_STORAGE_PATH:-/app/storage/analysis}
    command: celery -A celery_app worker --loglevel=info --concurrency=2
    restart: always
    networks:
      - app-network

  # Celery Beat
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    hostname: celery_beat
    volumes:
      - storage_data:/app/storage
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379/0
      - STORAGE_PATH=${STORAGE_PATH:-/app/storage}
      - VIDEO_STORAGE_PATH=${VIDEO_STORAGE_PATH:-/app/storage/videos}
      - ANALYSIS_STORAGE_PATH=${ANALYSIS_STORAGE_PATH:-/app/storage/analysis}
    command: celery -A celery_app beat --loglevel=info
    restart: always
    networks:
      - app-network

  # Next.js 前端 (使用 Supabase 数据库)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    hostname: frontend
    environment:
      # Supabase 数据库
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_PROVIDER=postgresql
      - DB_SINGLETON_ENABLED=true
      # 认证
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_URL=${AUTH_URL:-http://localhost:3000}
      # Google OAuth
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      - NEXT_PUBLIC_AUTH_GOOGLE_ID=${NEXT_PUBLIC_AUTH_GOOGLE_ID}
      - NEXT_PUBLIC_AUTH_GOOGLE_ENABLED=${NEXT_PUBLIC_AUTH_GOOGLE_ENABLED:-true}
      - NEXT_PUBLIC_AUTH_GOOGLE_ONE_TAP_ENABLED=${NEXT_PUBLIC_AUTH_GOOGLE_ONE_TAP_ENABLED:-true}
      # GitHub OAuth
      - AUTH_GITHUB_ID=${AUTH_GITHUB_ID}
      - AUTH_GITHUB_SECRET=${AUTH_GITHUB_SECRET}
      - NEXT_PUBLIC_AUTH_GITHUB_ENABLED=${NEXT_PUBLIC_AUTH_GITHUB_ENABLED:-true}
      # 后端 API
      - BACKEND_API_URL=http://gateway:8000
      # 应用配置
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-TikTok视频分析器}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_APP_DESCRIPTION=${NEXT_PUBLIC_APP_DESCRIPTION:-AI驱动的TikTok视频分析平台}
      - NEXT_PUBLIC_THEME=${NEXT_PUBLIC_THEME:-default}
      - NEXT_PUBLIC_APPEARANCE=${NEXT_PUBLIC_APPEARANCE:-system}
    ports:
      - "3001:3000"
    depends_on:
      - gateway
    restart: always
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  redis_data:
  storage_data:
